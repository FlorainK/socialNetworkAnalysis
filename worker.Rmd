Datensatz: spotify daten, diese bestehen aus edges und nodes. In edges sind Kollaborationen zwischen zwei Künstlern festgehalten. In den Nodes stehen Zusatzinformationen zu allen Künstlern wie Genre, Follower und Beliebtheit


Einlesen der Datensätze
```{r}

install_if_not <- function(pkg) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}

install_if_not("igraph")
edges <- read.csv("./data/edges.csv", header = TRUE)
nodes <- read.csv("./data/nodes.csv", header = TRUE)
```


1. Forschungsfrage zum Erkunden des Datensatzes:
  Welches "Künstlerpaar" hatte die meisten Kollaborationen

Benötigt werden hierfür sowohl Edges, als auch Nodes da in den Nodes die Künster nicht mit ihrem Namen enthalten sind, sondern mit einer eindeutigen Identifikationsnummer. Durch diese und die Nodes kann jeder ID der entsprechende Künstlername zugeordnet werden

```{r}
install_if_not("tidyverse")
install_if_not("dplyr")
install_if_not("GGally")
install_if_not("network")
install_if_not("tibble")
install_if_not("networkD3")
install_if_not("data.table")
library(networkD3)
library(data.table)
# Entfernen der Zeilen, welche eine ID enthalten, die nicht in den nodes steht


filteredEdges <- edges[edges$id_0 %in% nodes$spotify_id, ]
filteredEdges <- filteredEdges[filteredEdges$id_1 %in% nodes$spotify_id, ]

# Anzahl der Künstler, die mehr als eine Kollaboration hatten:
counts <- group_size(group_by(filteredEdges, id_0, id_1))
counts[counts > 1]
```
2. Forschungsfrage:
  Welche Genres sind am häufigsten in dem Datensatz enthalten

```{r}

numberOfGenres <- function(element) {
  element <- strsplit(element, ",")
  element <- unlist(element)
  return(length(element))
}

# Add column with genre of artist 0
filteredEdges["genre_0"] <- nodes[match(filteredEdges$id_0, nodes$spotify_id), "genres"]
# Add column with genre of artist 1
filteredEdges["genre_1"] <- nodes[match(filteredEdges$id_1, nodes$spotify_id), "genres"]


# transform the rows genre_0 and genre_1 into a vector
filteredEdges$genre_0 <- as.vector(filteredEdges$genre_0)
filteredEdges$genre_1 <- as.vector(filteredEdges$genre_1)

# create a new column with the genres of both artists
filteredEdges$genres <- paste(filteredEdges$genre_0, filteredEdges$genre_1, sep = ", ")

# remove the columns genre_0 and genre_1
filteredEdges <- filteredEdges[, -c(3, 4)]


#  count the genres
genreCounts <- table(unlist(strsplit(as.character(filteredEdges$genres), ", ")))
genreCounts <- as.data.frame(genreCounts)
colnames(genreCounts) <- c("genre", "count")
genreCounts <- genreCounts[order(genreCounts$count, decreasing = TRUE), ]

# remove [ and ] from the genres and replace no gonre with unknown
genreCounts$genre <- str_replace(genreCounts$genre, "\\[\\]", "unknown")
genreCounts$genre <- gsub("\\[", "", genreCounts$genre)
genreCounts$genre <- gsub("\\]", "", genreCounts$genre)


# plot the top 10 genres
ggplot(genreCounts[1:10, ], aes(x = reorder(genre, count), y = count)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Genre", y = "Count of Collaborations", title = "Top 10 Genres in the Dataset")

# calculate mean number of genres per artist

mean(unlist(lapply(filteredEdges$genres, numberOfGenres)))
```

-> Die häufigsten Genres sind Pop, edm und electro house
  -> Dennoch sind die meisten Kollaborationen mit einem oder beiden Künstlern ohne zugeordnetes Genre
  -> Durchschnittlich 4,9 genres pro Künsterin

3. Forschungsfrage:
  wie sind die einzelnen Genres untereinander vernetzt

Hierfür wird lediglich ein genre pro Künstler betrachtet


```{r}

genreCollaborations <- filteredEdges[, c(1, 2)]

getFirstGenre <- function(genreList) {
  if (length(genreList) == 4) {
    return("unknown")
  } else {
    quotePositions <- unlist(gregexpr("\\'", genreList))
    return(substr(genreList, quotePositions[1] + 1, quotePositions[2] - 1))
  }
}

# add column with genre of artist 0
genreCollaborations["genre_0"] <- nodes[match(genreCollaborations$id_0, nodes$spotify_id), "genres"]
# add column with genre of artist 1
genreCollaborations["genre_1"] <- nodes[match(genreCollaborations$id_1, nodes$spotify_id), "genres"]

# keep only first genre per artist
genreCollaborations$genre_0 <- sapply(genreCollaborations$genre_0, getFirstGenre)
genreCollaborations$genre_1 <- sapply(genreCollaborations$genre_1, getFirstGenre)

# remove rows with unknown genre
genreCollaborations <- subset(genreCollaborations, genre_0 != "NA" & genre_1 != "NA")

# remove rows with same genre
genreCollaborations <- subset(genreCollaborations, genre_0 != genre_1)
# remove first two columns
genreCollaborations <- genreCollaborations[, -c(1, 2)]

# create a network
genreNetwork <- network(genreCollaborations, directed = FALSE, multiple = TRUE)

# plot the network
plot(genreNetwork, vertex.label = NA, vertex.size = 5, vertex.color = "blue", edge.width = 0.1, edge.color = "grey")

# calculate the degree of each genre
genreDegree <- degree(graph_from_data_frame(genreCollaborations, directed = FALSE, vertices = NULL))
genreDegree <- as.data.frame(genreDegree)
genreDegree <- tibble::rownames_to_column(genreDegree, "genre")
colnames(genreDegree) <- c("genre", "degree")
genreDegree <- genreDegree[order(genreDegree$degree, decreasing = TRUE), ]

# plot the top 10 genres
ggplot(genreDegree[1:10, ], aes(x = reorder(genre, degree), y = degree)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Genre", y = "Degree", title = "Top 10 Genres by Degree")

#  Genres sind alphabetisch sortiert - daher ist die Betrachtung lediglich des ersten Genres nicht repräsentativ
```


Weitere Idee:
  Wie Kollaborieren die 20 größten Artists miteinander
  Learning: 20 größten Artists hatten so viele Kollaborationen, dass die Visualisierung nicht mehr möglich war
  -> Lediglich 5 Größten und deren Features wurden betrachtet

```{r}
# get the 5 biggest artists
biggestArtists <- nodes[order(nodes$followers, decreasing = TRUE), ][1:5, ]


# get the collaborations of the 5 biggest artists
biggestArtistsCollaborationsEdges <- subset(filteredEdges, id_0 %in% biggestArtists$spotify_id | id_1 %in% biggestArtists$spotify_id)
rownames(biggestArtistsCollaborationsEdges) <- NULL
# rename id_0 to source and id_1 to target
colnames(biggestArtistsCollaborationsEdges) <- c("source", "target")

# filter nodes if they are not in biggestArtistsCollaborations
biggestArtistsNodes <- nodes[nodes$spotify_id %in% biggestArtistsCollaborationsEdges$source | nodes$spotify_id %in% biggestArtistsCollaborationsEdges$target, ]

# replace the id by a number
biggestArtistsNodes$new_id <- as.numeric(factor(biggestArtistsNodes$spotify_id))

#  replace each id in biggestArtistsCollaborations with the new_id
biggestArtistsCollaborationsEdges$source <- biggestArtistsNodes[match(biggestArtistsCollaborationsEdges$source, biggestArtistsNodes$spotify_id), "new_id"]
biggestArtistsCollaborationsEdges$target <- biggestArtistsNodes[match(biggestArtistsCollaborationsEdges$target, biggestArtistsNodes$spotify_id), "new_id"]


# replace each id in biggestArtistsNodes with a consecutive number starting at 1


# print row where spotify_id is '215', '253'
biggestArtistsNodes[biggestArtistsNodes$new_id %in% c(215, 253), ]


# somehow "Armaan Malik" and "SLAVA MARLOW" are twice in the dataset -> remove one of them
biggestArtistsNodes <- subset(biggestArtistsNodes, !(new_id == 215 & name == "Armaan Malik" & followers == 5))
biggestArtistsNodes <- subset(biggestArtistsNodes, !(new_id == 253 & name == "SLAVA MARLOW" & followers == 347))

# order the nodes by spotify_id
biggestArtistsNodes <- biggestArtistsNodes[order(biggestArtistsNodes$spotify_id), ]

# set spotify_id as rownames
rownames(biggestArtistsNodes) <- biggestArtistsNodes$new_id


# replace the spotify ids with the artist names
# biggestArtistsCollaborationsEdges$id_0 <- nodes[match(biggestArtistsCollaborationsEdges$id_0, nodes$spotify_id), "name"]
# biggestArtistsCollaborationsEdges$id_1 <- nodes[match(biggestArtistsCollaborationsEdges$id_1, nodes$spotify_id), "name"]

# add column with true or false if artist in biggestArtists to biggestArtistsNodes
biggestArtistsNodes <- cbind(biggestArtistsNodes, isBiggestArtist = biggestArtistsNodes$spotify_id %in% biggestArtists$spotify_id)

# drop spotify_id column
biggestArtistsNodes <- biggestArtistsNodes[, -1]
# print lines where isBiggestArtist is true
biggestArtistsNodes[biggestArtistsNodes$isBiggestArtist == TRUE, ]

# change the wording of isbiggestArtist to "TOP 5" or "OTHER"
biggestArtistsNodes$isBiggestArtist <- ifelse(biggestArtistsNodes$isBiggestArtist == TRUE, "TOP 5", "OTHER")



# lower source and target by 1
biggestArtistsCollaborationsEdges$source <- biggestArtistsCollaborationsEdges$source - 1
biggestArtistsCollaborationsEdges$target <- biggestArtistsCollaborationsEdges$target - 1
p <- simpleNetwork(biggestArtistsCollaborationsEdges)
saveNetwork(p, file = "biggestArtistsCollaborations.html")

d <- forceNetwork(
  Links = biggestArtistsCollaborationsEdges,
  Nodes = biggestArtistsNodes,
  Source = "source",
  Target = "target",
  NodeID = "name",
  Group = "isBiggestArtist",
  opacity = 0.8,
  fontSize = 20,
  Nodesize = "followers",
  radiusCalculation = JS("(d.nodesize / 10000000)+5"),
  zoom = TRUE,
  colourScale = JS("d3.scaleOrdinal([ '#05f2fa','#021433'])"),
  legend = TRUE,
)

saveNetwork(d, file = "biggestArtistsCollaborations2.html")
  ```

```{r}
data(MisLinks)
data(MisNodes)

d <- MisLinks
n <- MisNodes
```

further Ideas:
Betrachtung der Chartplazierungen:
  - Wie spielen Followerzahl und Chartplazierung zusammen?
  (Korrelationen)
  (Followerzahl eines einzelnen Artists, sowie durchschnitt der  beiden)
  - Wie spielen Genre und Chartplazierung zusammen?



```{r}


# get a list of all genres
genres <- unlist(strsplit(nodes$genres, ","))
# remove empty strings, remove whitespaces, [ and ], and ' from the strings
genres <- gsub(" ", "", genres)
genres <- gsub("\\[", "", genres)
genres <- gsub("\\]", "", genres)
genres <- gsub("'", "", genres)
# remove empty strings
genres <- genres[genres != ""]
# get the unique genres
genres <- unique(genres)

# create a dataframe with the genres and the number of followers
genresFollowers <- data.frame(genre = genres, followers = 0)

# create function to get the number of followers for a genre
getFollowers <- function(genre) {
  return(sum(nodes[nodes$name %like% sprintf("%s", genre), ]$followers))
}

# for each genre, add the followers of the artists that have this genre
genresFollowers$followers <- sapply(genresFollowers$genre, getFollowers)


nodes[nodes$name %like% "'rap'", ]
# sort the genres by the number of followers
genresFollowers <- genresFollowers[order(genresFollowers$followers, decreasing = TRUE), ]

# plot the genres with the most followers
barplot(genresFollowers$followers, names.arg = genresFollowers$genre, las = 2, cex.names = 0.5, col = "blue")
```

Korrelation der Follower von Artist 1 und Artist 2

```{r}
# create new dataframe with the spotify_ids of the artists
followerDataframe <- filteredEdges

# replace the spotify id by the number of followers
followerDataframe$id_0 <- nodes[match(followerDataframe$id_0, nodes$spotify_id), "followers"]
followerDataframe$id_1 <- nodes[match(followerDataframe$id_1, nodes$spotify_id), "followers"]


# rename the columns
colnames(followerDataframe) <- c("followers_0", "followers_1")

followerDataframe$followers_0

# calculate the correlation of the followers
cor(followerDataframe$followers_0, followerDataframe$followers_1, use = "complete.obs")
```


Betrachung der deutschen Musikszene:
  -> zu groß für die Visualisierung
      -> deutsche Rap szene auch zu groß
       neuedeutschewelle


WElche Genres haben die meisten follower


```{r}
#  get all german artists in rap
germanArtistsNodes <- nodes[nodes$genre %like% "german" | nodes$genre %like% "deutsch", ]
# get the 5 biggest artists
germanArtistsNodes <- germanArtistsNodes[order(germanArtistsNodes$followers, decreasing = TRUE), ][1:5, ]


# get the collaborations of the 5 biggest artists
germanArtistsEdges <- subset(filteredEdges, id_0 %in% germanArtistsNodes$spotify_id | id_1 %in% germanArtistsNodes$spotify_id)
rownames(germanArtistsEdges) <- NULL
# rename id_0 to source and id_1 to target
colnames(germanArtistsEdges) <- c("source", "target")

# filter nodes if they are not in biggestArtistsCollaborations
germanArtistsNodes <- nodes[nodes$spotify_id %in% germanArtistsEdges$source | nodes$spotify_id %in% germanArtistsEdges$target, ]

# replace the id by a number
germanArtistsNodes$new_id <- as.numeric(factor(germanArtistsNodes$spotify_id))

#  replace each id
germanArtistsEdges$source <- germanArtistsNodes[match(germanArtistsEdges$source, germanArtistsNodes$spotify_id), "new_id"]
germanArtistsEdges$target <- germanArtistsNodes[match(germanArtistsEdges$target, germanArtistsNodes$spotify_id), "new_id"]

# order by new_id
germanArtistsNodes <- germanArtistsNodes[order(germanArtistsNodes$new_id), ]

# set spotify_id as rownames
rownames(germanArtistsNodes) <- germanArtistsNodes$new_id


# drop spotify_id column
germanArtistsNodes <- germanArtistsNodes[, -1]

# insert row isgerman
germanArtistsNodes$isgerman <- germanArtistsNodes$genre %like% "german" | germanArtistsNodes$genre %like% "deutsch"

# change wording of isgerman to "deutsch" and "nicht deutsch"
germanArtistsNodes$isgerman <- ifelse(germanArtistsNodes$isgerman, "deutsch", "nicht deutsch")

# lower source and target by 1
germanArtistsEdges$source <- germanArtistsEdges$source - 1
germanArtistsEdges$target <- germanArtistsEdges$target - 1

n <- forceNetwork(
  Links = germanArtistsEdges,
  Nodes = germanArtistsNodes,
  Source = "source",
  Target = "target",
  NodeID = "name",
  Group = "isgerman",
  opacity = 0.8,
  fontSize = 20,
  Nodesize = "followers",
  radiusCalculation = JS("(d.nodesize / 10000000)+5"),
  zoom = TRUE,
  colourScale = JS("d3.scaleOrdinal([ '#05f2fa','#021433'])"),
  legend = TRUE,
)

saveNetwork(n, file = "germanMusicScene.html")
```

